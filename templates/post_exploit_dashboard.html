<!-- templates/post_exploit_dashboard.html -->
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Tableau de bord Post-Exploitation</h1>
        <div>
            <span class="badge bg-success">Cible: {{ target_ip }}</span>
            {% if session_id %}
            <span class="badge bg-info">Session: {{ session_id }}</span>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Informations système -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-server"></i> Informations Système
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <tbody>
                            <tr>
                                <th>Hostname</th>
                                <td>{{ system_info.hostname }}</td>
                            </tr>
                            <tr>
                                <th>Système d'exploitation</th>
                                <td>{{ system_info.os }}</td>
                            </tr>
                            <tr>
                                <th>Noyau</th>
                                <td>{{ system_info.kernel }}</td>
                            </tr>
                            <tr>
                                <th>Architecture</th>
                                <td>{{ system_info.architecture }}</td>
                            </tr>
                            <tr>
                                <th>Uptime</th>
                                <td>{{ system_info.uptime }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('post_exploit.get_system_info', target_ip=target_ip) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-cogs"></i> Détails système
                    </a>
                </div>
            </div>
        </div>

        <!-- Informations utilisateurs -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-users"></i> Informations Utilisateurs
                </div>
                <div class="card-body">
                    <p><strong>Utilisateur actuel:</strong> {{ user_info.current_user }}</p>
                    
                    {% if user_info.logged_users.users %}
                    <p><strong>Utilisateurs connectés ({{ user_info.logged_users.count }}):</strong></p>
                    <ul class="list-group">
                        {% for user in user_info.logged_users.users %}
                        <li class="list-group-item">{{ user }}</li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>Aucun utilisateur connecté ou erreur de récupération</p>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('post_exploit.get_users_info', target_ip=target_ip) }}" class="btn btn-sm btn-success">
                        <i class="fas fa-user-shield"></i> Détails utilisateurs
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning">
                    <i class="fas fa-bolt"></i> Actions rapides
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <a href="{{ url_for('post_exploit.get_network_info', target_ip=target_ip) }}" class="btn btn-info btn-block w-100">
                                <i class="fas fa-network-wired"></i> Informations réseau
                            </a>
                        </div>
                        <div class="col-md-4 mb-2">
                            <a href="{{ url_for('post_exploit.get_processes', target_ip=target_ip) }}" class="btn btn-info btn-block w-100">
                                <i class="fas fa-tasks"></i> Processus
                            </a>
                        </div>
                        <div class="col-md-4 mb-2">
                            <a href="{{ url_for('post_exploit.file_operations', target_ip=target_ip, operation='list', path='/') }}" class="btn btn-info btn-block w-100">
                                <i class="fas fa-folder-open"></i> Explorateur de fichiers
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Terminal -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <i class="fas fa-terminal"></i> Terminal
                </div>
                <div class="card-body bg-dark">
                    <div id="terminal-output" class="text-light" style="height: 300px; overflow-y: auto; font-family: monospace;">
                        <div class="prompt">root@{{ system_info.hostname }}:~# <span class="cursor">_</span></div>
                    </div>
                    <form id="command-form" class="mt-2">
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-light border-secondary">
                                <i class="fas fa-chevron-right"></i>
                            </span>
                            <input type="text" id="command-input" class="form-control bg-dark text-light border-secondary" 
                                   placeholder="Entrez une commande..." autocomplete="off">
                            <input type="hidden" name="target_ip" value="{{ target_ip }}">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane"></i> Exécuter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Persistance -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <i class="fas fa-lock"></i> Établir la persistance
                </div>
                <div class="card-body">
                    <form id="persistence-form">
                        <div class="mb-3">
                            <label for="persistence-method" class="form-label">Méthode de persistance</label>
                            <select id="persistence-method" name="method" class="form-select">
                                <option value="crontab">Tâche cron</option>
                                <option value="startup_script">Script de démarrage</option>
                            </select>
                        </div>
                        <input type="hidden" name="target_ip" value="{{ target_ip }}">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-key"></i> Établir la persistance
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion du terminal
    const terminalOutput = document.getElementById('terminal-output');
    const commandForm = document.getElementById('command-form');
    const commandInput = document.getElementById('command-input');
    
    // Fonction pour ajouter du texte au terminal
    function appendToTerminal(text, isCommand = false) {
        const line = document.createElement('div');
        if (isCommand) {
            line.innerHTML = `<span class="text-success">root@{{ system_info.hostname }}:~#</span> <span class="text-warning">${text}</span>`;
        } else {
            line.textContent = text;
        }
        terminalOutput.appendChild(line);
        terminalOutput.scrollTop = terminalOutput.scrollHeight;
    }
    
    // Soumission de commande
    commandForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const command = commandInput.value.trim();
        if (!command) return;
        
        appendToTerminal(command, true);
        
        // Envoyer la commande au serveur
        fetch("{{ url_for('post_exploit.execute_command') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                command: command,
                target_ip: "{{ target_ip }}"
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                appendToTerminal(data.result);
            } else {
                appendToTerminal(`Erreur: ${data.result}`);
            }
            
            // Ajouter un nouveau prompt
            const promptDiv = document.createElement('div');
            promptDiv.className = 'prompt';
            promptDiv.innerHTML = `root@{{ system_info.hostname }}:~# <span class="cursor">_</span>`;
            terminalOutput.appendChild(promptDiv);
            
            // Effacer l'entrée
            commandInput.value = '';
        })
        .catch(error => {
            appendToTerminal(`Erreur de connexion: ${error}`);
        });
    });
    
    // Gestion du formulaire de persistance
    const persistenceForm = document.getElementById('persistence-form');
    
    persistenceForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const method = document.getElementById('persistence-method').value;
        
        fetch("{{ url_for('post_exploit.establish_persistence') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                method: method,
                target_ip: "{{ target_ip }}"
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "succès") {
                alert(`Persistance établie avec succès: ${data.details.then(data => {
            if (data.status === "succès") {
                alert(`Persistance établie avec succès: ${data.details}`);
            } else {
                alert(`Échec de l'établissement de persistance: ${data.error || 'Erreur inconnue'}`);
            }
        })
        .catch(error => {
            alert(`Erreur de connexion: ${error}`);
        });
    });
});
</script>

<style>
.cursor {
    animation: blink 1s step-end infinite;
}

@keyframes blink {
    from, to { opacity: 1; }
    50% { opacity: 0; }
}

.prompt {
    color: #00ff00; /* Vert pour simuler un terminal classique */
}
</style>
{% endblock %}